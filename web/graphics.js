var json = {"nodes": [{"orank": 27, "group": 1, "brank": 29, "name": "ARI"}, {"orank": 9, "group": 1, "brank": 1, "name": "ATL"}, {"orank": 1, "group": 1, "brank": 2, "name": "BAL"}, {"orank": 15, "group": 1, "brank": 22, "name": "BUF"}, {"orank": 25, "group": 1, "brank": 31, "name": "CAR"}, {"orank": 4, "group": 1, "brank": 5, "name": "CHI"}, {"orank": 18, "group": 1, "brank": 26, "name": "CIN"}, {"orank": 24, "group": 1, "brank": 17, "name": "CLE"}, {"orank": 30, "group": 1, "brank": 21, "name": "DAL"}, {"orank": 28, "group": 1, "brank": 30, "name": "DEN"}, {"orank": 16, "group": 1, "brank": 14, "name": "DET"}, {"orank": 2, "group": 1, "brank": 7, "name": "GB"}, {"orank": 31, "group": 1, "brank": 23, "name": "HOU"}, {"orank": 8, "group": 1, "brank": 11, "name": "IND"}, {"orank": 23, "group": 1, "brank": 18, "name": "JAC"}, {"orank": 14, "group": 1, "brank": 13, "name": "KC"}, {"orank": 10, "group": 1, "brank": 12, "name": "MIA"}, {"orank": 13, "group": 1, "brank": 15, "name": "MIN"}, {"orank": 0, "group": 1, "brank": 0, "name": "NE"}, {"orank": 3, "group": 1, "brank": 6, "name": "NO"}, {"orank": 11, "group": 1, "brank": 10, "name": "NYG"}, {"orank": 5, "group": 1, "brank": 4, "name": "NYJ"}, {"orank": 12, "group": 1, "brank": 19, "name": "OAK"}, {"orank": 6, "group": 1, "brank": 9, "name": "PHI"}, {"orank": 7, "group": 1, "brank": 3, "name": "PIT"}, {"orank": 22, "group": 1, "brank": 16, "name": "SD"}, {"orank": 20, "group": 1, "brank": 25, "name": "SEA"}, {"orank": 26, "group": 1, "brank": 28, "name": "SF"}, {"orank": 19, "group": 1, "brank": 27, "name": "STL"}, {"orank": 17, "group": 1, "brank": 8, "name": "TB"}, {"orank": 29, "group": 1, "brank": 24, "name": "TEN"}, {"orank": 21, "group": 1, "brank": 20, "name": "WAS"}], "links": [{"fas": 0, "target": 17, "value": 1, "source": 19}, {"fas": 0, "target": 3, "value": 1, "source": 16}, {"fas": 0, "target": 10, "value": 1, "source": 5}, {"fas": 1, "target": 22, "value": 1, "source": 30}, {"fas": 0, "target": 6, "value": 1, "source": 18}, {"fas": 0, "target": 4, "value": 1, "source": 20}, {"fas": 0, "target": 1, "value": 1, "source": 24}, {"fas": 0, "target": 7, "value": 1, "source": 29}, {"fas": 0, "target": 9, "value": 1, "source": 14}, {"fas": 1, "target": 13, "value": 1, "source": 12}, {"fas": 0, "target": 27, "value": 1, "source": 26}, {"fas": 0, "target": 23, "value": 1, "source": 11}, {"fas": 1, "target": 28, "value": 1, "source": 0}, {"fas": 0, "target": 8, "value": 1, "source": 31}, {"fas": 0, "target": 21, "value": 1, "source": 2}, {"fas": 0, "target": 25, "value": 1, "source": 15}, {"fas": 0, "target": 0, "value": 1, "source": 1}, {"fas": 1, "target": 2, "value": 1, "source": 6}, {"fas": 0, "target": 7, "value": 1, "source": 15}, {"fas": 0, "target": 8, "value": 1, "source": 5}, {"fas": 0, "target": 10, "value": 1, "source": 23}, {"fas": 0, "target": 3, "value": 1, "source": 11}, {"fas": 0, "target": 30, "value": 1, "source": 24}, {"fas": 0, "target": 17, "value": 1, "source": 16}, {"fas": 0, "target": 4, "value": 1, "source": 29}, {"fas": 0, "target": 28, "value": 1, "source": 22}, {"fas": 1, "target": 26, "value": 1, "source": 9}, {"fas": 1, "target": 18, "value": 1, "source": 21}, {"fas": 0, "target": 14, "value": 1, "source": 25}, {"fas": 1, "target": 31, "value": 1, "source": 12}, {"fas": 0, "target": 20, "value": 1, "source": 13}, {"fas": 0, "target": 27, "value": 1, "source": 19}, {"fas": 0, "target": 10, "value": 1, "source": 17}, {"fas": 0, "target": 3, "value": 1, "source": 18}, {"fas": 1, "target": 19, "value": 1, "source": 1}, {"fas": 1, "target": 20, "value": 1, "source": 30}, {"fas": 0, "target": 27, "value": 1, "source": 15}, {"fas": 0, "target": 29, "value": 1, "source": 24}, {"fas": 0, "target": 4, "value": 1, "source": 6}, {"fas": 0, "target": 7, "value": 1, "source": 2}, {"fas": 0, "target": 12, "value": 1, "source": 8}, {"fas": 0, "target": 14, "value": 1, "source": 23}, {"fas": 0, "target": 31, "value": 1, "source": 28}, {"fas": 1, "target": 22, "value": 1, "source": 0}, {"fas": 0, "target": 25, "value": 1, "source": 26}, {"fas": 0, "target": 9, "value": 1, "source": 13}, {"fas": 0, "target": 16, "value": 1, "source": 21}, {"fas": 1, "target": 11, "value": 1, "source": 5}, {"fas": 0, "target": 27, "value": 1, "source": 1}, {"fas": 0, "target": 3, "value": 1, "source": 21}, {"fas": 1, "target": 6, "value": 1, "source": 7}, {"fas": 0, "target": 10, "value": 1, "source": 11}, {"fas": 0, "target": 30, "value": 1, "source": 9}, {"fas": 0, "target": 26, "value": 1, "source": 28}, {"fas": 0, "target": 4, "value": 1, "source": 19}, {"fas": 0, "target": 24, "value": 1, "source": 2}, {"fas": 1, "target": 13, "value": 1, "source": 14}, {"fas": 1, "target": 22, "value": 1, "source": 12}, {"fas": 0, "target": 0, "value": 1, "source": 25}, {"fas": 1, "target": 23, "value": 1, "source": 31}, {"fas": 1, "target": 5, "value": 1, "source": 20}, {"fas": 0, "target": 16, "value": 1, "source": 18}, {"fas": 1, "target": 3, "value": 1, "source": 14}, {"fas": 0, "target": 6, "value": 1, "source": 29}, {"fas": 0, "target": 7, "value": 1, "source": 1}, {"fas": 0, "target": 28, "value": 1, "source": 10}, {"fas": 0, "target": 15, "value": 1, "source": 13}, {"fas": 1, "target": 11, "value": 1, "source": 31}, {"fas": 0, "target": 4, "value": 1, "source": 5}, {"fas": 0, "target": 9, "value": 1, "source": 2}, {"fas": 0, "target": 12, "value": 1, "source": 20}, {"fas": 1, "target": 19, "value": 1, "source": 0}, {"fas": 0, "target": 25, "value": 1, "source": 22}, {"fas": 0, "target": 8, "value": 1, "source": 30}, {"fas": 0, "target": 27, "value": 1, "source": 23}, {"fas": 0, "target": 17, "value": 1, "source": 21}, {"fas": 1, "target": 5, "value": 1, "source": 26}, {"fas": 1, "target": 11, "value": 1, "source": 16}, {"fas": 0, "target": 25, "value": 1, "source": 28}, {"fas": 0, "target": 2, "value": 1, "source": 18}, {"fas": 0, "target": 10, "value": 1, "source": 20}, {"fas": 0, "target": 1, "value": 1, "source": 23}, {"fas": 0, "target": 7, "value": 1, "source": 24}, {"fas": 1, "target": 15, "value": 1, "source": 12}, {"fas": 0, "target": 29, "value": 1, "source": 19}, {"fas": 1, "target": 22, "value": 1, "source": 27}, {"fas": 0, "target": 9, "value": 1, "source": 21}, {"fas": 0, "target": 8, "value": 1, "source": 17}, {"fas": 0, "target": 31, "value": 1, "source": 13}, {"fas": 1, "target": 14, "value": 1, "source": 30}, {"fas": 0, "target": 6, "value": 1, "source": 1}, {"fas": 1, "target": 5, "value": 1, "source": 31}, {"fas": 1, "target": 23, "value": 1, "source": 30}, {"fas": 0, "target": 14, "value": 1, "source": 15}, {"fas": 0, "target": 16, "value": 1, "source": 24}, {"fas": 1, "target": 19, "value": 1, "source": 7}, {"fas": 0, "target": 28, "value": 1, "source": 29}, {"fas": 0, "target": 27, "value": 1, "source": 4}, {"fas": 0, "target": 3, "value": 1, "source": 2}, {"fas": 0, "target": 0, "value": 1, "source": 26}, {"fas": 0, "target": 25, "value": 1, "source": 18}, {"fas": 0, "target": 9, "value": 1, "source": 22}, {"fas": 0, "target": 17, "value": 1, "source": 11}, {"fas": 0, "target": 8, "value": 1, "source": 20}, {"fas": 0, "target": 6, "value": 1, "source": 16}, {"fas": 0, "target": 8, "value": 1, "source": 14}, {"fas": 0, "target": 31, "value": 1, "source": 10}, {"fas": 0, "target": 3, "value": 1, "source": 15}, {"fas": 0, "target": 4, "value": 1, "source": 28}, {"fas": 0, "target": 21, "value": 1, "source": 11}, {"fas": 0, "target": 9, "value": 1, "source": 27}, {"fas": 0, "target": 30, "value": 1, "source": 25}, {"fas": 0, "target": 0, "value": 1, "source": 29}, {"fas": 0, "target": 17, "value": 1, "source": 18}, {"fas": 0, "target": 26, "value": 1, "source": 22}, {"fas": 0, "target": 24, "value": 1, "source": 19}, {"fas": 0, "target": 12, "value": 1, "source": 13}, {"fas": 0, "target": 29, "value": 1, "source": 1}, {"fas": 0, "target": 3, "value": 1, "source": 5}, {"fas": 1, "target": 18, "value": 1, "source": 7}, {"fas": 0, "target": 10, "value": 1, "source": 21}, {"fas": 0, "target": 4, "value": 1, "source": 19}, {"fas": 0, "target": 16, "value": 1, "source": 2}, {"fas": 0, "target": 12, "value": 1, "source": 25}, {"fas": 0, "target": 0, "value": 1, "source": 17}, {"fas": 0, "target": 26, "value": 1, "source": 20}, {"fas": 0, "target": 13, "value": 1, "source": 23}, {"fas": 0, "target": 15, "value": 1, "source": 22}, {"fas": 0, "target": 8, "value": 1, "source": 11}, {"fas": 0, "target": 6, "value": 1, "source": 24}, {"fas": 1, "target": 2, "value": 1, "source": 1}, {"fas": 0, "target": 10, "value": 1, "source": 3}, {"fas": 0, "target": 17, "value": 1, "source": 5}, {"fas": 0, "target": 7, "value": 1, "source": 21}, {"fas": 0, "target": 6, "value": 1, "source": 13}, {"fas": 0, "target": 30, "value": 1, "source": 16}, {"fas": 0, "target": 4, "value": 1, "source": 29}, {"fas": 0, "target": 12, "value": 1, "source": 14}, {"fas": 1, "target": 15, "value": 1, "source": 9}, {"fas": 1, "target": 20, "value": 1, "source": 8}, {"fas": 0, "target": 0, "value": 1, "source": 26}, {"fas": 1, "target": 28, "value": 1, "source": 27}, {"fas": 0, "target": 24, "value": 1, "source": 18}, {"fas": 0, "target": 31, "value": 1, "source": 23}, {"fas": 0, "target": 16, "value": 1, "source": 5}, {"fas": 0, "target": 6, "value": 1, "source": 3}, {"fas": 1, "target": 10, "value": 1, "source": 8}, {"fas": 0, "target": 12, "value": 1, "source": 21}, {"fas": 0, "target": 22, "value": 1, "source": 24}, {"fas": 0, "target": 4, "value": 1, "source": 2}, {"fas": 0, "target": 7, "value": 1, "source": 14}, {"fas": 0, "target": 30, "value": 1, "source": 31}, {"fas": 0, "target": 0, "value": 1, "source": 15}, {"fas": 0, "target": 17, "value": 1, "source": 11}, {"fas": 0, "target": 26, "value": 1, "source": 19}, {"fas": 0, "target": 28, "value": 1, "source": 1}, {"fas": 0, "target": 27, "value": 1, "source": 29}, {"fas": 0, "target": 13, "value": 1, "source": 18}, {"fas": 0, "target": 20, "value": 1, "source": 23}, {"fas": 0, "target": 9, "value": 1, "source": 25}, {"fas": 0, "target": 10, "value": 1, "source": 18}, {"fas": 0, "target": 8, "value": 1, "source": 19}, {"fas": 0, "target": 6, "value": 1, "source": 21}, {"fas": 1, "target": 11, "value": 1, "source": 1}, {"fas": 0, "target": 3, "value": 1, "source": 24}, {"fas": 0, "target": 23, "value": 1, "source": 5}, {"fas": 0, "target": 4, "value": 1, "source": 7}, {"fas": 0, "target": 14, "value": 1, "source": 20}, {"fas": 0, "target": 31, "value": 1, "source": 17}, {"fas": 0, "target": 29, "value": 1, "source": 2}, {"fas": 1, "target": 30, "value": 1, "source": 12}, {"fas": 0, "target": 26, "value": 1, "source": 15}, {"fas": 0, "target": 22, "value": 1, "source": 16}, {"fas": 0, "target": 9, "value": 1, "source": 28}, {"fas": 1, "target": 13, "value": 1, "source": 25}, {"fas": 0, "target": 0, "value": 1, "source": 27}, {"fas": 0, "target": 12, "value": 1, "source": 23}, {"fas": 0, "target": 6, "value": 1, "source": 19}, {"fas": 0, "target": 10, "value": 1, "source": 5}, {"fas": 0, "target": 27, "value": 1, "source": 11}, {"fas": 0, "target": 30, "value": 1, "source": 14}, {"fas": 0, "target": 9, "value": 1, "source": 15}, {"fas": 1, "target": 16, "value": 1, "source": 7}, {"fas": 0, "target": 3, "value": 1, "source": 17}, {"fas": 0, "target": 31, "value": 1, "source": 20}, {"fas": 0, "target": 29, "value": 1, "source": 1}, {"fas": 0, "target": 25, "value": 1, "source": 22}, {"fas": 0, "target": 4, "value": 1, "source": 26}, {"fas": 0, "target": 0, "value": 1, "source": 28}, {"fas": 1, "target": 13, "value": 1, "source": 8}, {"fas": 1, "target": 2, "value": 1, "source": 24}, {"fas": 0, "target": 21, "value": 1, "source": 18}, {"fas": 0, "target": 30, "value": 1, "source": 13}, {"fas": 0, "target": 7, "value": 1, "source": 3}, {"fas": 0, "target": 5, "value": 1, "source": 18}, {"fas": 1, "target": 11, "value": 1, "source": 10}, {"fas": 0, "target": 6, "value": 1, "source": 24}, {"fas": 0, "target": 31, "value": 1, "source": 29}, {"fas": 0, "target": 4, "value": 1, "source": 1}, {"fas": 1, "target": 22, "value": 1, "source": 14}, {"fas": 1, "target": 26, "value": 1, "source": 27}, {"fas": 0, "target": 28, "value": 1, "source": 19}, {"fas": 1, "target": 21, "value": 1, "source": 16}, {"fas": 0, "target": 9, "value": 1, "source": 0}, {"fas": 1, "target": 15, "value": 1, "source": 25}, {"fas": 0, "target": 8, "value": 1, "source": 23}, {"fas": 0, "target": 17, "value": 1, "source": 20}, {"fas": 0, "target": 12, "value": 1, "source": 2}, {"fas": 0, "target": 27, "value": 1, "source": 25}, {"fas": 0, "target": 7, "value": 1, "source": 6}, {"fas": 1, "target": 31, "value": 1, "source": 8}, {"fas": 0, "target": 12, "value": 1, "source": 30}, {"fas": 0, "target": 14, "value": 1, "source": 13}, {"fas": 0, "target": 28, "value": 1, "source": 15}, {"fas": 1, "target": 16, "value": 1, "source": 3}, {"fas": 0, "target": 29, "value": 1, "source": 10}, {"fas": 0, "target": 0, "value": 1, "source": 4}, {"fas": 0, "target": 19, "value": 1, "source": 2}, {"fas": 0, "target": 20, "value": 1, "source": 23}, {"fas": 0, "target": 26, "value": 1, "source": 1}, {"fas": 0, "target": 24, "value": 1, "source": 21}, {"fas": 0, "target": 9, "value": 1, "source": 22}, {"fas": 0, "target": 11, "value": 1, "source": 18}, {"fas": 0, "target": 17, "value": 1, "source": 5}, {"fas": 0, "target": 4, "value": 1, "source": 24}, {"fas": 0, "target": 8, "value": 1, "source": 0}, {"fas": 0, "target": 3, "value": 1, "source": 18}, {"fas": 0, "target": 21, "value": 1, "source": 5}, {"fas": 0, "target": 7, "value": 1, "source": 2}, {"fas": 0, "target": 30, "value": 1, "source": 15}, {"fas": 0, "target": 27, "value": 1, "source": 28}, {"fas": 1, "target": 16, "value": 1, "source": 10}, {"fas": 0, "target": 26, "value": 1, "source": 29}, {"fas": 0, "target": 14, "value": 1, "source": 31}, {"fas": 0, "target": 22, "value": 1, "source": 13}, {"fas": 0, "target": 12, "value": 1, "source": 9}, {"fas": 0, "target": 20, "value": 1, "source": 11}, {"fas": 0, "target": 25, "value": 1, "source": 6}, {"fas": 0, "target": 1, "value": 1, "source": 19}, {"fas": 1, "target": 23, "value": 1, "source": 17}, {"fas": 0, "target": 4, "value": 1, "source": 1}, {"fas": 0, "target": 7, "value": 1, "source": 24}, {"fas": 1, "target": 17, "value": 1, "source": 10}, {"fas": 0, "target": 5, "value": 1, "source": 11}, {"fas": 0, "target": 30, "value": 1, "source": 13}, {"fas": 0, "target": 15, "value": 1, "source": 22}, {"fas": 0, "target": 16, "value": 1, "source": 18}, {"fas": 0, "target": 31, "value": 1, "source": 20}, {"fas": 0, "target": 6, "value": 1, "source": 2}, {"fas": 1, "target": 14, "value": 1, "source": 12}, {"fas": 1, "target": 19, "value": 1, "source": 29}, {"fas": 0, "target": 3, "value": 1, "source": 21}, {"fas": 1, "target": 23, "value": 1, "source": 8}, {"fas": 0, "target": 0, "value": 1, "source": 27}, {"fas": 0, "target": 9, "value": 1, "source": 25}, {"fas": 1, "target": 28, "value": 1, "source": 26}]};

var matrix = function(body, opts) {
    var margin = opts.margin,
        height = opts.height,
        width = opts.width;

    var x = d3.scale.ordinal().rangeBands([0, width]),
    z = d3.scale.linear().domain([0, 4]).clamp(true),
    c = d3.scale.category10().domain(d3.range(2));

    var svg = d3.select(body).append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.style("margin-left", -margin.left + "px")
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    function makeMatrix(season) {
	var matrix = [],
	nodes = season.nodes,
	n = nodes.length;

	// Compute index per node.
	nodes.forEach(function(node, i) {
	    node.index = i;
	    node.count = 0;
	    matrix[i] = d3.range(n).map(function(j) { return {x: j, y: i, z: 0}; });
	});

	season.links.forEach(function(link) {
	    matrix[link.source][link.target].z += link.value;
	    matrix[link.source][link.source].z += link.value;
	    nodes[link.source].count += link.value;
	});

	// Precompute the orders.
	var orders = {
	    name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].name, nodes[b].name); }),
	    orank: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].orank, nodes[b].orank); }),
            brank: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].brank, nodes[b].brank); }),
	    count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; })
	};

	var losses = {
	    name: 0,
	    orank: 0,
            brank: 0,
	    count: 0
	};
	// Compute losses.
	for (ordering in losses) {
	    season.links.forEach(function(link) {
		x.domain(orders[ordering]);
		if (x(link.source) > x(link.target)) {
		    losses[ordering] += 1;
		}
	    });
	}
	
	// The default sort order.
	x.domain(orders.name);
	d3.select('#loss').html(losses.name);

	svg.append("rect")
	    .attr("class", "background")
	    .attr("width", width)
	    .attr("height", height)
            .attr("style", "fill: #EEE;");

	var row = svg.selectAll(".row")
	    .data(matrix)
	    .enter().append("g")
	    .attr("class", "row")
	    .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
	    .each(row);

	row.append("line")
	    .attr("x2", width);

	row.append("text")
	    .attr("x", -6)
	    .attr("y", x.rangeBand() / 2)
	    .attr("dy", ".32em")
	    .attr("text-anchor", "end")
	    .text(function(d, i) { return nodes[i].name; });

	var column = svg.selectAll(".column")
	    .data(matrix)
	    .enter().append("g")
	    .attr("class", "column")
	    .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

	column.append("line")
	    .attr("x1", -width);

	column.append("text")
	    .attr("x", 6)
	    .attr("y", x.rangeBand() / 2)
	    .attr("dy", ".32em")
	    .attr("text-anchor", "start")
	    .text(function(d, i) { return nodes[i].name; });

	function row(row) {
	    var cell = d3.select(this).selectAll(".cell")
		.data(row.filter(function(d) { return d.z; }))
		.enter().append("rect")
		.attr("class", "cell")
		.attr("x", function(d) { return x(d.x); })
		.attr("width", x.rangeBand())
		.attr("height", x.rangeBand())
		.style("fill-opacity", function(d) { return z(d.z); })
		.style("fill", function(d) { return nodes[d.x].group == nodes[d.y].group ? c(nodes[d.x].group) : null; })
		.on("mouseover", mouseover)
		.on("mouseout", mouseout);
	}

	function mouseover(p) {
	    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
	    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
	}

	function mouseout() {
	    d3.selectAll("text").classed("active", false);
	}

	function order(value) {
	    
	    x.domain(orders[value]);

	    var t = svg.transition().duration(500);

	    t.selectAll(".row")
		.delay(function(d, i) { return x(i) * 4; })
		.attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
		.selectAll(".cell")
		.delay(function(d) { return x(d.x) * 4; })
		.attr("x", function(d) { return x(d.x); });

	    t.selectAll(".column")
		.delay(function(d, i) { return x(i) * 4; })
		.attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
	}

	var timeout = setTimeout(function() {
	    order("group");
	    d3.select("#order").property("selectedIndex", 2).node().focus();
	}, 5000);

	d3.selectAll(".graph-nav").on("click", function() {
	    clearTimeout(timeout);
	    order(this.id);
	    d3.select('#loss').html(losses[this.id]);
	});


    }
    makeMatrix(json);

}

var graph = function() {
    var w = 960,
    h = 720;

    var svg = d3.select("body").append("svg:svg")
	.attr("width", w)
	.attr("height", h);

    // Per-type markers, as they don't inherit styles.
    svg.append("svg:defs").selectAll("marker")
	.data(["fas", "nonfas"])
	.enter().append("svg:marker")
	.attr("id", String)
	.attr("viewBox", "0 -5 10 10")
	.attr("refX", 15)
	.attr("refY", -1.5)
	.attr("markerWidth", 6)
	.attr("markerHeight", 6)
	.attr("orient", "auto")
	.append("svg:path")
	.attr("d", "M0,-5L10,0L0,5");

    d3.json("nfl2010.json", function(graph) {

	var force = d3.layout.force()
	    .nodes(d3.values(graph.nodes))
	    .links(graph.links)
	    .size([w, h])
	    .linkDistance(300)
	    .charge(-300)
	    .on("tick", tick)
	    .start();

	var path = svg.append("svg:g").selectAll("path")
	    .data(force.links())
	    .enter().append("svg:path")
	    .attr("class", function(d) { if (d.fas) { return "link fas";} else { return "link" }})
	    .attr("marker-end", function(d) { if (d.fas) { return "url(#fas)"; } else { return "url(#nonfas)"; }});

	var circle = svg.append("svg:g").selectAll("circle")
	    .data(force.nodes())
	    .enter().append("svg:circle")
	    .attr("r", 6)
	    .call(force.drag);

	var text = svg.append("svg:g").selectAll("g")
	    .data(force.nodes())
	    .enter().append("svg:g");

	// A copy of the text with a thick white stroke for legibility.
	text.append("svg:text")
	    .attr("x", 8)
	    .attr("y", ".31em")
	    .attr("class", "shadow")
	    .text(function(d) { return d.name; });

	text.append("svg:text")
	    .attr("x", 8)
	    .attr("y", ".31em")
	    .text(function(d) { return d.name; });

	// Use elliptical arc path segments to doubly-encode directionality.
	function tick() {
	    path.attr("d", function(d) {
		var dx = d.target.x - d.source.x,
		dy = d.target.y - d.source.y,
		dr = Math.sqrt(dx * dx + dy * dy);
		return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
	    });

	    circle.attr("transform", function(d) {
		return "translate(" + d.x + "," + d.y + ")";
	    });

	    text.attr("transform", function(d) {
		return "translate(" + d.x + "," + d.y + ")";
	    });
	}
    });
}


